<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QueueWorks</title>
    <link rel="icon" type="image/x-icon" href="/Media/head.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main>
        <div class="container-live">
            <div class="card-live">
                <div class="navbar-live">
                    <div class="navbar-buttons-live">
                        <a href="index.html" class="nav-link-live">Home</a>
                        <a href="live.html" class="nav-link-live">Live</a>
                        <a href="login.html" class="nav-link-live">Login</a>
                    </div>
                </div>
                <img src="/Media/logo.svg" alt="QueueWorks Logo" class="logo-live">
                
                <div id="auth-check" class="loading-screen">
                    <p>Checking authentication...</p>
                </div>
                
                <div id="admin-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="margin: 0;">Admin Dashboard</h1>
                        <button id="logout-btn" class="button-small">Logout</button>
                    </div>
                    
                    <div id="notify" class="notify"></div>
                    
                    <div class="admin-controls">
                        <select name="lehrjahr" id="lehrjahr" class="input-field">
                            <option value="">All Tickets</option>
                            <option value="Basis">Basis</option>
                            <option value="Praxis">Praxis</option>
                        </select>
                        <button id="refresh-tickets" class="button">üîÑ Refresh</button>
                        <button id="delete-selected" class="deletebuttons">Delete Selected</button>
                        <button id="delete-all" class="deletebuttons">Delete All Tickets</button>
                    </div>

                    <div id="tickets-container" class="tickets-grid">
                        <p>Loading tickets...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 QueueWorks</p>
    </footer>

    <script type="module">
        const API_URL = 'http://localhost:3000/tickets';
        const AUTH_KEY = 'queueworks_admin_session';
        let selectedTicketId = null;
        let allTickets = [];

        // Check authentication on page load
        async function checkAuth() {
            const authCheck = document.getElementById('auth-check');
            const adminContent = document.getElementById('admin-content');
            
            // Check if user has valid session
            const sessionToken = sessionStorage.getItem(AUTH_KEY);
            
            if (!sessionToken) {
                authCheck.innerHTML = `
                    <div class="access-denied">
                        <h2>‚õî Zugriff verweigert</h2>
                        <p>Sie m√ºssen sich anmelden, um auf das Admin-Dashboard zuzugreifen.</p>
                        <a href="login.html">Zur Anmeldung</a>
                    </div>
                `;
                return false;
            }
            
            // Verify session with backend
            try {
                const resp = await fetch('http://localhost:3000/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (!resp.ok) throw new Error('Invalid session');
                
                // Authentication successful
                authCheck.style.display = 'none';
                adminContent.style.display = 'block';
                return true;
            } catch (err) {
                console.error('Auth verification failed:', err);
                sessionStorage.removeItem(AUTH_KEY);
                authCheck.innerHTML = `
                    <div class="access-denied">
                        <h2>‚è±Ô∏è Sitzung abgelaufen</h2>
                        <p>Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an.</p>
                        <a href="login.html">Zur Anmeldung</a>
                    </div>
                `;
                return false;
            }
        }

        async function loadTickets(filterLJ = '') {
            const notify = document.getElementById('notify');
            const container = document.getElementById('tickets-container');
            notify.textContent = '';
            
            try {
                const sessionToken = sessionStorage.getItem(AUTH_KEY);
                const resp = await fetch(API_URL, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (!resp.ok) throw new Error(`Server ${resp.status}`);
                const tickets = await resp.json();
                allTickets = tickets;
                
                // Apply filter if specified
                const filteredTickets = filterLJ 
                    ? tickets.filter(t => t.LJ === filterLJ)
                    : tickets;
                
                renderTickets(filteredTickets);
            } catch (err) {
                console.error('Failed to load tickets:', err);
                notify.textContent = 'Fehler beim Laden der Tickets.';
                container.innerHTML = '';
            }
        }

        function renderTickets(tickets) {
            const container = document.getElementById('tickets-container');
            container.innerHTML = '';
            
            if (!tickets || tickets.length === 0) {
                container.textContent = 'No tickets found.';
                return;
            }
            
            tickets.forEach(t => {
                const el = document.createElement('div');
                el.className = 'ticket-box';
                el.dataset.id = t.id;
                
                if (selectedTicketId === t.id) {
                    el.classList.add('selected');
                }
                
                el.innerHTML = `
                    <div class="ticket-header">
                        <strong>#${t.id}</strong>
                        <em>${escapeHtml(t.cat || '')}</em>
                        <small>${t.LJ || ''}</small>
                    </div>
                    <p><strong>${escapeHtml(t.name)}</strong></p>
                    <p>${escapeHtml(t.msg)}</p>
                `;
                
                el.addEventListener('click', () => {
                    document.querySelectorAll('.ticket-box').forEach(box => box.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedTicketId = t.id;
                });
                
                container.appendChild(el);
            });
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Event listeners
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                sessionStorage.removeItem(AUTH_KEY);
                window.location.href = 'login.html';
            }
        });
        
        document.getElementById('lehrjahr').addEventListener('change', (e) => {
            const filterValue = e.target.value;
            loadTickets(filterValue);
        });

        document.getElementById('refresh-tickets').addEventListener('click', () => {
            const lj = document.getElementById('lehrjahr').value;
            loadTickets(lj);
            document.getElementById('notify').textContent = 'Tickets refreshed!';
            setTimeout(() => {
                document.getElementById('notify').textContent = '';
            }, 2000);
        });

        document.getElementById('delete-selected').addEventListener('click', async () => {
            if (!selectedTicketId) {
                alert('Please select a ticket first.');
                return;
            }
            
            if (!confirm(`Delete ticket #${selectedTicketId}? This cannot be undone.`)) return;
            
            try {
                const sessionToken = sessionStorage.getItem(AUTH_KEY);
                const resp = await fetch(`${API_URL}/${selectedTicketId}`, { 
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                if (!resp.ok) throw new Error(`Server ${resp.status}`);
                
                document.getElementById('notify').textContent = 'Ticket deleted successfully.';
                selectedTicketId = null;
                const lj = document.getElementById('lehrjahr').value;
                loadTickets(lj);
            } catch (err) {
                console.error('Failed to delete ticket:', err);
                alert('Error deleting ticket.');
            }
        });

        document.getElementById('delete-all').addEventListener('click', async () => {
            if (!confirm('Delete ALL tickets? This cannot be undone.')) return;
            
            try {
                const sessionToken = sessionStorage.getItem(AUTH_KEY);
                const resp = await fetch(API_URL, { 
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                if (!resp.ok) throw new Error(`Server ${resp.status}`);
                
                document.getElementById('notify').textContent = 'All tickets deleted.';
                selectedTicketId = null;
                loadTickets();
            } catch (err) {
                console.error('Failed to delete all tickets:', err);
                alert('Error deleting tickets.');
            }
        });

        // Initialize
        (async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadTickets();
            }
        })();
    </script>
</body>
</html>