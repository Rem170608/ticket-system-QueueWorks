<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Setup - QueueWorks</title>
    <link rel="icon" type="image/x-icon" href="/Media/head.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main>
        <div class="container">
            <div class="card">
                <div class="navbar">
                    <div class="navbar-buttons">
                        <a href="index.html" class="nav-link">Home</a>
                        <a href="live.html" class="nav-link">Live</a>
                        <a href="login.html" class="nav-link" id="loginNavLink">Login</a>
                    </div>
                </div>
                <img src="/Media/logo.svg" alt="logo" class="logo">
                
                <h2>Admin Setup</h2>
                
                <div id="errorMessage" style="color: #ff0000; background: rgba(255, 0, 0, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; display: none; text-align: center;"></div>
                <div id="successMessage" style="color: #00ff00; background: rgba(0, 255, 0, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; display: none; text-align: center;"></div>
                
                <div id="setupForm" style="display: none;">
                      <div class="input-with-icon">
                        <input type="text" placeholder="Benutzername" id="usernameInput" class="input-field" value="noserq_user" autocomplete="username" disabled>
                    </div>
                    <div class="input-with-icon">
                    <div class="input-with-icon">
                        <input type="password" placeholder="Neues Passwort" id="newPasswordInput" class="input-field">
                        <button id="showNewPasswordBtn" type="button" class="show-password" aria-label="Toggle password visibility" title="Toggle password visibility">
                            <img id="newEyeIcon" src="/Media/icons8-closed-eye-50.png" alt="Show password" />
                        </button>
                    </div>
                    
                    <div class="input-with-icon">
                        <input type="password" placeholder="Passwort bestätigen" id="confirmPasswordInput" class="input-field">
                        <button id="showConfirmPasswordBtn" type="button" class="show-password" aria-label="Toggle password visibility" title="Toggle password visibility">
                            <img id="confirmEyeIcon" src="/Media/icons8-closed-eye-50.png" alt="Show password" />
                        </button>
                    </div>
                    
                    <button id="setupBtn" type="button" class="button">Passwort setzen</button>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 QueueWorks</p>
    </footer>

    <script>
        const API_URL = 'http://localhost:3000';

        // Check if admin already exists
        async function checkAdminExists() {
            try {
                const response = await fetch(`${API_URL}/auth/check-admin`);
                
                // Log the response details for debugging
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                // Handle non-200 responses more specifically
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server response:', errorText);
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    console.error('Invalid content type:', contentType);
                    throw new Error("Server sent non-JSON response");
                }

                const data = await response.json();
                console.log('Server response data:', data);
                
                if (data.adminExists) {
                    // If admin exists, redirect to login and show message
                    sessionStorage.setItem('setupMessage', 'Admin bereits eingerichtet. Bitte melden Sie sich an.');
                    window.location.href = 'login.html';
                    return;
                }

                // Update navigation link to show admin-setup while on setup page
                const loginNavLink = document.getElementById('loginNavLink');
                if (loginNavLink) {
                    loginNavLink.href = 'admin-setup.html';
                }

                // Show setup form
                document.getElementById('setupForm').style.display = 'block';
                
                // Clear any existing error messages
                document.getElementById('errorMessage').style.display = 'none';
            } catch (error) {
                console.error('Setup check error:', error);
                // Show more specific error message
                const errorMessage = document.getElementById('errorMessage');
                if (error.message.includes('Failed to fetch')) {
                    errorMessage.textContent = 'Server nicht erreichbar. Bitte stellen Sie sicher, dass der Server läuft und auf Port 3000 erreichbar ist.';
                } else {
                    errorMessage.textContent = `Fehler beim Überprüfen des Admin-Status: ${error.message}`;
                }
                errorMessage.style.display = 'block';
            }
        }

        // Initialize password toggles
        document.addEventListener('DOMContentLoaded', function () {
            // Check if admin exists
            checkAdminExists();

            // Setup password toggles
            const passwordConfigs = [
                {
                    input: document.getElementById('newPasswordInput'),
                    button: document.getElementById('showNewPasswordBtn'),
                    icon: document.getElementById('newEyeIcon')
                },
                {
                    input: document.getElementById('confirmPasswordInput'),
                    button: document.getElementById('showConfirmPasswordBtn'),
                    icon: document.getElementById('confirmEyeIcon')
                }
            ];
            
            passwordConfigs.forEach(config => {
                const { input, button, icon } = config;
                
                // Show password on mousedown
                button.addEventListener('mousedown', () => {
                    input.type = 'text';
                    icon.src = '/Media/icons8-eye-50.png';
                });
                
                // Hide password on mouseup or mouseleave
                button.addEventListener('mouseup', () => {
                    input.type = 'password';
                    icon.src = '/Media/icons8-closed-eye-50.png';
                });
                
                button.addEventListener('mouseleave', () => {
                    input.type = 'password';
                    icon.src = '/Media/icons8-closed-eye-50.png';
                });
            });
            
            // Add Enter key handlers
            document.getElementById('newPasswordInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirmPasswordInput').focus();
                }
            });
            
            document.getElementById('confirmPasswordInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('setupBtn').click();
                }
            });
        });

        // Setup functionality
        document.getElementById('setupBtn')?.addEventListener('click', async function() {
            const password = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const setupBtn = document.getElementById('setupBtn');
            
            // Hide previous messages
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // Validate passwords
            if (!password || !confirmPassword) {
                errorMsg.textContent = 'Bitte füllen Sie beide Passwortfelder aus.';
                errorMsg.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorMsg.textContent = 'Die Passwörter stimmen nicht überein.';
                errorMsg.style.display = 'block';
                return;
            }
            
            setupBtn.disabled = true;
            setupBtn.textContent = 'Setting up...';
            setupBtn.style.opacity = '0.6';
            
            try {
                const response = await fetch(`${API_URL}/setup/create-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMsg.textContent = 'Admin account created! Redirecting to login...';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    errorMsg.textContent = data.error || 'Setup failed. Please try again.';
                    errorMsg.style.display = 'block';
                    setupBtn.disabled = false;
                    setupBtn.textContent = 'Passwort setzen';
                    setupBtn.style.opacity = '1';
                }
            } catch (error) {
                console.error('Setup error:', error);
                errorMsg.textContent = 'Connection error. Please try again.';
                errorMsg.style.display = 'block';
                setupBtn.disabled = false;
                setupBtn.textContent = 'Passwort setzen';
                setupBtn.style.opacity = '1';
            }
        });
    </script>
</body>
</html>